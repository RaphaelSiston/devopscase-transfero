trigger:
  branches:
    include:
      - main

variables:
  vmImage: ubuntu-latest

stages:
- stage: Build
  displayName: Build
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Build stage"
      displayName: Build Application

- stage: Tests
  displayName: Tests
  dependsOn: Build
  jobs:
  - job: Tests
    displayName: Tests Job
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Running unit tests"
        echo "Running integration tests"
        echo "Running load tests"
      displayName: Run Tests

- stage: Quality
  displayName: Code Quality - SonarCloud
  dependsOn: Tests
  jobs:
  - job: Sonar
    displayName: SonarCloud Analysis
    pool:
      vmImage: $(vmImage)
    steps:
    - task: SonarCloudPrepare@1
      displayName: Prepare SonarCloud
      inputs:
        SonarCloud: SonarCloudServiceConnection
        organization: sua-org
        scannerMode: CLI
        configMode: manual
        cliProjectKey: devops-case
        cliProjectName: devops-case

    - task: SonarCloudAnalyze@1
      displayName: Run SonarCloud Analysis

    - task: SonarCloudPublish@1
      displayName: Publish Quality Gate Result
      inputs:
        pollingTimeoutSec: "300"

- stage: Security
  displayName: Security - DAST
  dependsOn: Quality
  jobs:
  - job: DAST
    displayName: OWASP ZAP Scan
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Running DAST with OWASP ZAP"
        docker run --rm owasp/zap2docker-stable zap-baseline.py -t http://app:8080 -r zap-report.html || true
      displayName: Run OWASP ZAP

    - publish: zap-report.html
      artifact: dast-report
      displayName: Publish DAST Report

- stage: Deploy_Staging
  displayName: Deploy Staging
  dependsOn: Security
  jobs:
  - job: DeployStaging
    displayName: Deploy to Staging
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Deploy to staging"
        kubectl apply -f k8s/
      displayName: Apply Kubernetes Manifests

- stage: K8s_Governance
  displayName: Kubernetes Governance
  dependsOn: Deploy_Staging
  jobs:
  - job: Governance
    displayName: Validate and Auto-Fix Kubernetes
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        chmod +x scripts/validate_k8s.sh
        ./scripts/validate_k8s.sh
      displayName: Run Governance Script

- stage: Approval
  displayName: Manual Approval
  dependsOn: K8s_Governance
  jobs:
  - job: Approval
    displayName: Approval Gate
    pool: server
    steps:
    - task: ManualValidation@0
      displayName: Await Manual Approval
      inputs:
        notifyUsers: techlead@empresa.com
        instructions: Aprovação obrigatória para deploy em produção
        onTimeout: reject
      timeoutInMinutes: 60

- stage: Deploy_Prod
  displayName: Deploy Production
  dependsOn: Approval
  jobs:
  - job: DeployProd
    displayName: Deploy to Production
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Deploy to production"
        kubectl apply -f k8s/
      displayName: Apply Kubernetes Manifests (Prod)

- stage: Audit
  displayName: Audit Report
  dependsOn: Deploy_Prod
  jobs:
  - job: Audit
    displayName: Generate Audit Report
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo '{ "tests": "passed", "quality_gate": "passed", "security": "checked", "kubernetes_policy": "compliant" }' > audit-report.json
      displayName: Generate Audit File

    - publish: audit-report.json
      artifact: audit-report
      displayName: Publish Audit Report
