trigger:
  branches:
    include:
      - main

variables:
  vmImage: ubuntu-latest

stages:

- stage: Build
  displayName: Build
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Build stage"
      displayName: Build Application


- stage: Tests
  displayName: Tests
  dependsOn: Build
  jobs:
  - job: Tests
    displayName: Tests Job
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Running unit tests"
        echo "Running integration tests"
        echo "Running load tests"
      displayName: Run Tests


- stage: Quality
  displayName: Code Quality - SonarCloud
  dependsOn: Tests
  jobs:
  - job: Sonar
    displayName: SonarCloud Analysis
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Running SonarCloud analysis (placeholder)"
        echo "In real scenario: use SonarCloud tasks and quality gate"
      displayName: SonarCloud Scan


- stage: ManualApproval
  displayName: Manual Approval (Only if Tests Fail)
  dependsOn: Tests
  condition: failed()
  jobs:
  - job: Approval
    displayName: Await Manual Validation
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          Algum teste falhou ou não foi executado corretamente.
          Validação manual é obrigatória antes de seguir.
        # Ajuste para emails reais se quiser
        notifyUsers: 'devops@empresa.com'


- stage: Audit
  displayName: Audit & Compliance
  dependsOn:
    - Tests
    - Quality
  condition: always()
  jobs:
  - job: AuditJob
    displayName: Generate Audit Report
    pool:
      vmImage: $(vmImage)
    steps:
    - script: |
        echo "Generating audit report..."

        # Status do job atual (não é perfeito para refletir todos stages),
        # mas serve como evidência de auditoria automatizada.
        STATUS="${AGENT_JOBSTATUS}"
        DATE=$(date -u)

        cat <<EOF > audit-report.json
        {
          "pipeline": "$(Build.DefinitionName)",
          "buildId": "$(Build.BuildId)",
          "repository": "$(Build.Repository.Name)",
          "branch": "$(Build.SourceBranch)",
          "commit": "$(Build.SourceVersion)",
          "testsStage": "Tests",
          "qualityStage": "Quality",
          "auditJobStatus": "$STATUS",
          "timestampUtc": "$DATE",
          "auditedBy": "Azure DevOps Pipeline",
          "notes": "Logs seriam enviados ao Azure Monitor / App Insights via Diagnostic Settings em ambiente real."
        }
        EOF

        echo "Audit report created: audit-report.json"

        # Evidência de logs (simulando envio/integração)
        echo "##vso[task.logissue type=warning]Audit report generated (audit-report.json)"
        echo "##vso[task.logissue type=warning]Sending audit logs to Azure Monitor/App Insights (simulated)"
      displayName: Generate Audit Report

    - publish: audit-report.json
      artifact: audit-report
      displayName: Publish Audit Report Artifact
