trigger:
  branches:
    include:
      - main

variables:
  - name: K8S_MANIFEST
    value: "k8s/deployment.yml"
  - name: K8S_NAMESPACE
    value: "default"
  - name: DAST_TARGET_URL
    value: "https://example.com"

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build Job
        pool:
          name: self-hosted
        steps:
          - checkout: self
          - powershell: |
              Write-Host "Build stage"
            displayName: Build Application

  - stage: Tests
    displayName: Tests
    dependsOn: Build
    jobs:
      - job: Tests
        displayName: Tests Job
        pool:
          name: self-hosted
        steps:
          - checkout: self

          - powershell: |
              Write-Host "Running unit tests"
              "unit_ok" | Out-File -FilePath unit.txt -Encoding utf8

              Write-Host "Running integration tests"
              "integration_ok" | Out-File -FilePath integration.txt -Encoding utf8

              Write-Host "Running load tests"
              "load_ok" | Out-File -FilePath load.txt -Encoding utf8
            displayName: Run Tests

          - powershell: |
              if (!(Test-Path unit.txt)) { throw "unit.txt not found" }
              if (!(Test-Path integration.txt)) { throw "integration.txt not found" }
              if (!(Test-Path load.txt)) { throw "load.txt not found" }
              Write-Host "All tests executed"
            displayName: Validate tests executed

          - publish: unit.txt
            artifact: tests-unit
            displayName: Publish unit evidence

          - publish: integration.txt
            artifact: tests-integration
            displayName: Publish integration evidence

          - publish: load.txt
            artifact: tests-load
            displayName: Publish load evidence

  - stage: Quality
    displayName: Code Quality - SonarCloud
    dependsOn: Tests
    jobs:
      - job: Sonar
        displayName: SonarCloud Analysis
        pool:
          name: self-hosted
        steps:
          - checkout: self

          - powershell: |
              Write-Host "Running SonarCloud analysis (placeholder)"
              "QUALITY_GATE=OK" | Out-File -FilePath sonar-result.txt -Encoding utf8
              Get-Content sonar-result.txt
            displayName: SonarCloud Scan (simulated)

          - publish: sonar-result.txt
            artifact: sonar-report
            displayName: Publish Sonar report

  - stage: ManualApproval
    displayName: Manual Approval (Only if Tests/Quality Fail)
    dependsOn:
      - Tests
      - Quality
    condition: failed()
    jobs:
      - job: Approval
        displayName: Await Manual Validation
        pool: server
        steps:
          - task: ManualValidation@0
            inputs:
              instructions: |
                Um ou mais estágios falharam (Tests/Quality).
                O Líder Técnico deve revisar os logs e artifacts para aprovar exceção ou exigir correção.
                notifyUsers: "devops@empresa.com"
                onTimeout: reject
                timeoutInMinutes: 60

  - stage: Audit
    displayName: Audit & Compliance
    dependsOn:
      - Tests
      - Quality
      - ManualApproval
    condition: always()
    jobs:
      - job: AuditJob
        displayName: Generate Audit Report
        pool:
          name: self-hosted
        steps:
          - checkout: self

          - powershell: |
              Write-Host "Generating audit report..."

              $status = "$(Agent.JobStatus)"
              $date = (Get-Date).ToUniversalTime().ToString("o")

              $report = @{
                pipeline            = "$(Build.DefinitionName)"
                buildId             = "$(Build.BuildId)"
                repository          = "$(Build.Repository.Name)"
                branch              = "$(Build.SourceBranch)"
                commit              = "$(Build.SourceVersion)"
                testsStage          = "Tests"
                qualityStage        = "Quality"
                manualApprovalStage = "ManualApproval (conditional)"
                auditJobStatus      = $status
                timestampUtc        = $date
                auditedBy           = "Azure DevOps Pipeline"
                notes               = "Logs/metrics seriam integrados ao Azure Monitor / Grafana via Container Insights / Managed Prometheus / Azure Managed Grafana."
              } | ConvertTo-Json -Depth 5

              $report | Out-File -FilePath audit-report.json -Encoding utf8
              Write-Host "Audit report created: audit-report.json"
              Write-Host "##vso[task.logissue type=warning]Audit report generated (audit-report.json)"
              Write-Host "##vso[task.logissue type=warning]Sending audit logs to Azure Monitor/App Insights (simulated)"
            displayName: Generate Audit Report

          - publish: audit-report.json
            artifact: audit-report
            displayName: Publish Audit Report Artifact

  - stage: Deploy
    displayName: Deploy to Production (K8s) + Policy Fix (simulated)
    dependsOn: Audit
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: Deploy Job
        pool:
          name: self-hosted
        steps:
          - checkout: self

          - powershell: |
              New-Item -ItemType Directory -Force -Path out-manifests | Out-Null
              "Simulated corrected deployment manifest" | Out-File out-manifests/deployment.corrected.yml -Encoding utf8
              "Simulated HPA manifest" | Out-File out-manifests/hpa.generated.yml -Encoding utf8

              Write-Host "Simulating deploy..."
              Write-Host "kubectl apply -f out-manifests/deployment.corrected.yml -n $(K8S_NAMESPACE)"
              Write-Host "kubectl apply -f out-manifests/hpa.generated.yml -n $(K8S_NAMESPACE)"
            displayName: K8s Policy Fix + Deploy (simulated)

          - publish: out-manifests
            artifact: k8s-manifests
            displayName: Publish corrected manifests

  - stage: DAST
    displayName: DAST - OWASP ZAP (simulated)
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: ZapScan
        displayName: OWASP ZAP Scan
        pool:
          name: self-hosted
        steps:
          - checkout: none

          - powershell: |
              New-Item -ItemType Directory -Force -Path zap-out | Out-Null

              $html = @"
              <html><body>
              <h2>OWASP ZAP Report (SIMULATED)</h2>
              <p>Target: $(DAST_TARGET_URL)</p>
              <p>Status: OK (simulated)</p>
              </body></html>
              "@

              $html | Out-File -FilePath zap-out/zap_report.html -Encoding utf8
              '{ "target": "' + "$(DAST_TARGET_URL)" + '", "status": "OK", "mode": "simulated" }' |
                Out-File -FilePath zap-out/zap_report.json -Encoding utf8

              Write-Host "DAST scan simulated. Reports generated."
            displayName: Run DAST (simulated)

          - publish: zap-out
            artifact: dast-report
            displayName: Publish DAST report

  - stage: Observability
    displayName: Observability - Azure Monitor / Grafana (evidence)
    dependsOn: Deploy
    condition: always()
    jobs:
      - job: ObsEvidence
        displayName: Create Observability Evidence
        pool:
          name: self-hosted
        steps:
          - powershell: |
              New-Item -ItemType Directory -Force -Path observability | Out-Null

              $content = @'
              Observability Integration Plan (Azure Monitor + Kubernetes)
              ==========================================================
              Goal:
                - Collect CPU, memory and replicas from Kubernetes and visualize in Azure Monitor (Workbooks/Container Insights)
                  or Grafana (Azure Managed Grafana / Prometheus datasource).

              Recommended (AKS):
                1) Enable Container Insights:
                   az aks enable-addons -g <AKS_RG> -n <AKS_NAME> -a monitoring --workspace-resource-id <LAW_ID>

                2) Validate data:
                   Azure Monitor -> Containers (Insights)
                   Log Analytics -> KQL queries (Perf, InsightsMetrics, ContainerLog)

                3) Grafana:
                   - Use Azure Managed Grafana with Azure Monitor datasource (Log Analytics) OR
                   - Use Azure Managed Prometheus + Grafana Prometheus datasource.

              Metrics required:
                - CPU usage (nodes/pods/containers)
                - Memory usage (nodes/pods/containers)
                - Replicas desired/available (deployments) (kube-state-metrics / insights)

              Evidence in this pipeline:
                - This file documents the configuration steps and expected dashboards.
              '@

              $content | Out-File -FilePath observability/observability-evidence.txt -Encoding utf8
              Write-Host "Observability evidence generated."
            displayName: Generate Observability Evidence

          - publish: observability
            artifact: observability-evidence
            displayName: Publish Observability Evidence Artifact
