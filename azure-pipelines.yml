trigger:
  branches:
    include:
      - main

variables:
  - name: vmPool
    value: self-hosted

  # K8s / DAST (simulados)
  - name: K8S_NAMESPACE
    value: "default"
  - name: DAST_TARGET_URL
    value: "https://example.com"

  # Para DEMO: quando true, falha propositalmente em Tests
  - name: FORCE_FAIL_TESTS
    value: "false"

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: BuildJob
        displayName: Build Job
        pool:
          name: $(vmPool)
        steps:
          - checkout: self
          - task: PowerShell@2
            displayName: Build Application (simulated)
            inputs:
              targetType: inline
              script: |
                Write-Host "Build stage OK (simulated)"

  - stage: Tests
    displayName: Tests
    dependsOn: Build
    jobs:
      - job: TestsJob
        displayName: Tests Job
        pool:
          name: $(vmPool)
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: Run Tests (simulated)
            inputs:
              targetType: inline
              script: |
                Write-Host "Running unit tests"
                "unit_ok" | Out-File -FilePath unit.txt -Encoding utf8

                Write-Host "Running integration tests"
                "integration_ok" | Out-File -FilePath integration.txt -Encoding utf8

                Write-Host "Running load tests"
                "load_ok" | Out-File -FilePath load.txt -Encoding utf8

          - task: PowerShell@2
            displayName: Validate tests executed
            inputs:
              targetType: inline
              script: |
                if (!(Test-Path unit.txt)) { throw "unit.txt not found" }
                if (!(Test-Path integration.txt)) { throw "integration.txt not found" }
                if (!(Test-Path load.txt)) { throw "load.txt not found" }
                Write-Host "All tests executed"

          # >>> AQUI está a SIMULAÇÃO DO ERRO <<<
          - task: PowerShell@2
            displayName: Force failure (demo switch)
            inputs:
              targetType: inline
              script: |
                Write-Host "FORCE_FAIL_TESTS=$(FORCE_FAIL_TESTS)"
                if ("$(FORCE_FAIL_TESTS)" -eq "true") {
                  Write-Host "Forcing failure to trigger Manual Approval..."
                  throw "Forced failure (FORCE_FAIL_TESTS=true)"
                }
                Write-Host "No forced failure. Continuing."

          - publish: unit.txt
            artifact: tests-unit
            displayName: Publish unit evidence

          - publish: integration.txt
            artifact: tests-integration
            displayName: Publish integration evidence

          - publish: load.txt
            artifact: tests-load
            displayName: Publish load evidence

  - stage: Quality
    displayName: Code Quality - SonarCloud (simulated)
    dependsOn: Tests
    # Só roda Quality se Tests tiver passado (padrão gate)
    condition: succeeded()
    jobs:
      - job: SonarJob
        displayName: SonarCloud Analysis
        pool:
          name: $(vmPool)
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: SonarCloud Scan (simulated)
            inputs:
              targetType: inline
              script: |
                Write-Host "Running SonarCloud analysis (placeholder)"
                "QUALITY_GATE=OK" | Out-File -FilePath sonar-result.txt -Encoding utf8
                Get-Content sonar-result.txt

          - publish: sonar-result.txt
            artifact: sonar-report
            displayName: Publish Sonar report

  - stage: ManualApproval
    displayName: Manual Approval (Only if Tests/Quality Fail)
    dependsOn:
      - Tests
      - Quality
    # Se qualquer um falhar OU ficar skipped por conta de falha anterior, aciona aprovação
    condition: failed()
    jobs:
      - job: Approval
        displayName: Await Manual Validation
        pool: server
        steps:
          - task: ManualValidation@0
            inputs:
              instructions: |
                Um ou mais estágios falharam (Tests/Quality).
                O Líder Técnico deve revisar os logs e artifacts para aprovar exceção ou exigir correção.

                DEMO:
                - Para forçar falha: rode a pipeline com FORCE_FAIL_TESTS=true
                - Se aprovado: Deploy será liberado como exceção
                - Se rejeitado: Deploy será bloqueado
              notifyUsers: "devops@empresa.com"
              onTimeout: reject
              timeoutInMinutes: 60

  - stage: Audit
    displayName: Audit & Compliance
    dependsOn:
      - Tests
      - Quality
      - ManualApproval
    condition: always()
    jobs:
      - job: AuditJob
        displayName: Generate Audit Report
        pool:
          name: $(vmPool)
        steps:
          - checkout: self
          - task: PowerShell@2
            displayName: Generate Audit Report
            inputs:
              targetType: inline
              script: |
                Write-Host "Generating audit report..."

                $date = (Get-Date).ToUniversalTime().ToString("o")

                $report = @{
                  pipeline       = "$(Build.DefinitionName)"
                  buildId        = "$(Build.BuildId)"
                  repository     = "$(Build.Repository.Name)"
                  branch         = "$(Build.SourceBranch)"
                  commit         = "$(Build.SourceVersion)"
                  forceFailTests = "$(FORCE_FAIL_TESTS)"
                  testsResult    = "$(Agent.JobStatus)"
                  timestampUtc   = $date
                  notes          = "Audit always runs. In real use: integrate to Azure Monitor/App Insights."
                } | ConvertTo-Json -Depth 5

                $report | Out-File -FilePath audit-report.json -Encoding utf8
                Write-Host "Audit report created: audit-report.json"

          - publish: audit-report.json
            artifact: audit-report
            displayName: Publish Audit Report Artifact

  - stage: Deploy
    displayName: Deploy to Production (K8s) (simulated)
    dependsOn:
      - Audit
      - Tests
      - Quality
      - ManualApproval

    # Roda deploy se:
    # - Tests + Quality passaram
    # OU
    # - ManualApproval foi aprovado (exceção autorizada)
    condition: |
      or(
        and(succeeded('Tests'), succeeded('Quality')),
        succeeded('ManualApproval')
      )

    jobs:
      - job: DeployJob
        displayName: Deploy Job
        pool:
          name: $(vmPool)
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: K8s Deploy (simulated)
            inputs:
              targetType: inline
              script: |
                New-Item -ItemType Directory -Force -Path out-manifests | Out-Null
                "Simulated corrected deployment manifest" | Out-File out-manifests/deployment.corrected.yml -Encoding utf8
                "Simulated HPA manifest" | Out-File out-manifests/hpa.generated.yml -Encoding utf8

                Write-Host "Simulating deploy..."
                Write-Host "kubectl apply -f out-manifests/deployment.corrected.yml -n $(K8S_NAMESPACE)"
                Write-Host "kubectl apply -f out-manifests/hpa.generated.yml -n $(K8S_NAMESPACE)"

          - publish: out-manifests
            artifact: k8s-manifests
            displayName: Publish corrected manifests

  - stage: DAST
    displayName: DAST - OWASP ZAP (simulated)
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: ZapScan
        displayName: OWASP ZAP Scan
        pool:
          name: $(vmPool)
        steps:
          - checkout: none

          - task: PowerShell@2
            displayName: Run DAST (simulated)
            inputs:
              targetType: inline
              script: |
                New-Item -ItemType Directory -Force -Path zap-out | Out-Null

                $html = @"
                <html><body>
                <h2>OWASP ZAP Report (SIMULATED)</h2>
                <p>Target: $(DAST_TARGET_URL)</p>
                <p>Status: OK (simulated)</p>
                </body></html>
                "@

                $html | Out-File -FilePath zap-out/zap_report.html -Encoding utf8
                '{ "target": "' + "$(DAST_TARGET_URL)" + '", "status": "OK", "mode": "simulated" }'
