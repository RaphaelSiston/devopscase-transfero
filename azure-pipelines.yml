trigger:
  branches:
    include:
      - main

variables:
- group: sonarcloud-secrets

stages:
# =========================
# BUILD
# =========================
- stage: Build
  displayName: Build
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      name: 'self-hosted'
    steps:
    - script: |
        echo "Build stage"
      displayName: Build Application

# =========================
# TESTS
# =========================
- stage: Tests
  displayName: Tests
  dependsOn: Build
  jobs:
  - job: Tests
    displayName: Tests Job
    pool:
      name: 'self-hosted'
    steps:
    - script: |
        echo "Running unit tests"
        echo "Running integration tests"
        echo "Running load tests"
      displayName: Run Tests

# =========================
# CODE QUALITY - SONARCLOUD
# =========================
- stage: Quality
  displayName: Code Quality - SonarCloud (CLI)
  dependsOn: Tests
  jobs:
  - job: Sonar
    displayName: SonarCloud Analysis
    pool:
      name: 'self-hosted'
    steps:
    - checkout: self

    - powershell: |
        $version = "5.0.1.3006"
        $zip = "sonar-scanner-cli-$version-windows.zip"
        $url = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/$zip"

        Write-Host "Downloading SonarScanner..."
        Invoke-WebRequest -Uri $url -OutFile $zip

        Write-Host "Extracting SonarScanner..."
        Expand-Archive -Path $zip -DestinationPath . -Force

        $scanner = ".\sonar-scanner-$version-windows\bin\sonar-scanner.bat"

        Write-Host "Running SonarScanner..."
        & $scanner `
          "-Dsonar.host.url=https://sonarcloud.io" `
          "-Dsonar.organization=raphael-devops" `
          "-Dsonar.projectKey=raphael-devops_devops-case" `
          "-Dsonar.projectName=devops-case" `
          "-Dsonar.sources=." `
          "-Dsonar.login=$(SONAR_TOKEN)"
      displayName: Run SonarScanner (SonarCloud - Windows)

# =========================
# SECURITY - DAST (OWASP ZAP)
# =========================
- stage: Security
  displayName: Security - DAST
  dependsOn: Quality
  jobs:
  - job: DAST
    displayName: OWASP ZAP Scan
    pool:
      name: 'self-hosted'
    steps:
    - powershell: |
        Write-Host "Running DAST with OWASP ZAP"

        # garante que a imagem existe
        docker pull owasp/zap2docker-stable

          docker run --rm `
          owasp/zap2docker-stable `
          zap-baseline.py `
          -t http://app:8080 `
          -r zap-report.html

        if ($LASTEXITCODE -ne 0) {
          Write-Host "OWASP ZAP returned exit code $LASTEXITCODE - continuing pipeline"
          exit 0
        }
      displayName: Run OWASP ZAP

    - publish: zap-report.html
      artifact: dast-report
      displayName: Publish DAST Report


    - publish: zap-report.html
      artifact: dast-report
      displayName: Publish DAST Report

# =========================
# DEPLOY STAGING
# =========================
- stage: Deploy_Staging
  displayName: Deploy Staging
  dependsOn: Security
  jobs:
  - job: DeployStaging
    displayName: Deploy to Staging
    pool:
      name: 'self-hosted'
    steps:
    - script: |
        echo "Deploy to staging"
        kubectl apply -f k8s/
      displayName: Apply Kubernetes Manifests

# =========================
# KUBERNETES GOVERNANCE
# =========================
- stage: K8s_Governance
  displayName: Kubernetes Governance
  dependsOn: Deploy_Staging
  jobs:
  - job: Governance
    displayName: Validate and Auto-Fix Kubernetes
    pool:
      name: 'self-hosted'
    steps:
    - script: |
        chmod +x scripts/validate_k8s.sh
        ./scripts/validate_k8s.sh
      displayName: Run Governance Script

# =========================
# MANUAL APPROVAL
# =========================
- stage: Approval
  displayName: Manual Approval
  dependsOn: K8s_Governance
  jobs:
  - job: Approval
    displayName: Approval Gate
    pool: server
    steps:
    - task: ManualValidation@0
      displayName: Await Manual Approval
      inputs:
        notifyUsers: techlead@empresa.com
        instructions: Aprovação obrigatória para deploy em produção
        onTimeout: reject
      timeoutInMinutes: 60

# =========================
# DEPLOY PRODUCTION
# =========================
- stage: Deploy_Prod
  displayName: Deploy Production
  dependsOn: Approval
  jobs:
  - job: DeployProd
    displayName: Deploy to Production
    pool:
      name: 'self-hosted'
    steps:
    - script: |
        echo "Deploy to production"
        kubectl apply -f k8s/
      displayName: Apply Kubernetes Manifests (Prod)

# =========================
# AUDIT
# =========================
- stage: Audit
  displayName: Audit Report
  dependsOn: Deploy_Prod
  jobs:
  - job: Audit
    displayName: Generate Audit Report
    pool:
      name: 'self-hosted'
    steps:
    - script: |
        echo '{ "tests": "passed", "quality_gate": "passed", "security": "checked", "kubernetes_policy": "compliant" }' > audit-report.json
      displayName: Generate Audit File

    - publish: audit-report.json
      artifact: audit-report
      displayName: Publish Audit Report
