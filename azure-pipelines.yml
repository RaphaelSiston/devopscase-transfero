trigger:
  branches:
    include:
      - main

stages:

- stage: Build
  displayName: Build
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      name: self-hosted
    steps:
    - script: |
        echo "Build stage"
      displayName: Build Application

- stage: Tests
  displayName: Tests
  dependsOn: Build
  jobs:
  - job: Tests
    displayName: Tests Job
    pool:
      name: self-hosted
    steps:
    - script: |
        echo "Running unit tests"
        echo "Running integration tests"
        echo "Running load tests"
      displayName: Run Tests

- stage: Quality
  displayName: Code Quality - SonarCloud
  dependsOn: Tests
  jobs:
  - job: Sonar
    displayName: SonarCloud Analysis
    pool:
      name: self-hosted
    steps:
    - script: |
        echo "Running SonarCloud analysis (placeholder)"
        echo "In real scenario: use SonarCloud tasks and quality gate"
      displayName: SonarCloud Scan

- stage: ManualApproval
  displayName: Manual Approval (Only if Tests Fail)
  dependsOn: Tests
  condition: failed('Tests')
  jobs:
  - job: Approval
    displayName: Await Manual Validation
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          Algum teste falhou ou não foi executado corretamente.
          Validação manual é obrigatória antes de seguir.
        notifyUsers: 'devops@empresa.com'

- stage: Audit
  displayName: Audit & Compliance
  dependsOn:
    - Tests
    - Quality
  condition: always()
  jobs:
  - job: AuditJob
    displayName: Generate Audit Report
    pool:
      name: self-hosted
    steps:
    - powershell: |
        Write-Host "Generating audit report..."

        $status = "$(Agent.JobStatus)"
        $date = (Get-Date).ToUniversalTime().ToString("o")

        $report = @{
          pipeline      = "$(Build.DefinitionName)"
          buildId       = "$(Build.BuildId)"
          repository    = "$(Build.Repository.Name)"
          branch        = "$(Build.SourceBranch)"
          commit        = "$(Build.SourceVersion)"
          testsStage    = "Tests"
          qualityStage  = "Quality"
          auditJobStatus= $status
          timestampUtc  = $date
          auditedBy     = "Azure DevOps Pipeline"
          notes         = "Logs seriam enviados ao Azure Monitor / App Insights via Diagnostic Settings em ambiente real."
        } | ConvertTo-Json -Depth 5

        $report | Out-File -FilePath audit-report.json -Encoding utf8

        Write-Host "Audit report created: audit-report.json"
        Write-Host "##vso[task.logissue type=warning]Audit report generated (audit-report.json)"
        Write-Host "##vso[task.logissue type=warning]Sending audit logs to Azure Monitor/App Insights (simulated)"
      displayName: Generate Audit Report

    - publish: audit-report.json
      artifact: audit-report
      displayName: Publish Audit Report Artifact